#!perl

# Grep lines with (holonomic?) recurrences
# @(#) $Id$
# 2020-03-08, Georg Fischer
#
#:# Usage:
#:#   perl recform.pl cat25.txt > outfile
#---------------------------------
use strict;
use integer;
use warnings;
my $version = "V1.2";
my ($sec, $min, $hour, $mday, $mon, $year, $wday, $yday, $isdst) = localtime (time);
my $timestamp = sprintf ("%04d-%02d-%02d %02d:%02d:%02d"
        , $year + 1900, $mon + 1, $mday, $hour, $min, $sec);

my $debug  = 0;
while (scalar(@ARGV) > 0 and ($ARGV[0] =~ m{\A[\-\+]})) {
    my $opt = shift(@ARGV);
    if (0) {
    } elsif ($opt  =~ m{a}) {
    } elsif ($opt  =~ m{d}) {
        $debug  = shift(@ARGV);
    } else {
        die "invalid option \"$opt\"\n";
    }
} # while $opt

while (<>) {
    # if (m{^\%[NF] (A\d+)\s+([an\+\-\(\)\[\]\*\/\^\= 0-9]+)(\..*)}) {
    #             1        2                  3         4                      5                          6
    if (m{^\%[NF] (A\d+)\s+([CDP]\-finite\s+)?(with\s+)?([Rr]ecurrence[\:\s]+)?([an\+\-\(\)\*\/\^\= 0-9]+)(.*)}) {
        my ($aseqno, $expr, $rest) = ($1, $5, $6);
        my $ninits = 0;
        $expr =~ s{\.}{}; 
        if (    ($expr =~ m{a\(n\)} ) 
            and ($expr !~ m{\^[\(an]}    )
            and ($rest !~ m{\A\.\s*(\.\d|\.\.)} )
            ) {
            $expr =~ s{\s}{}g;
            if (0 and ($expr =~ m{\/(.*)})) { # move divisor before - fails rather often
                my $divisor = $1;
                $expr =~ s{\/.*}{};
                $expr = "$divisor*$expr";
            } # divisor
            #                      1                      2           3
            if ($rest =~ m{\A\,?\s*(for |with |when )?n\s*([\=\>]+)\s*(\d*)\s*[\.\,\;]}) {
                my ($relop, $ninits) = ($2, $3);
                if ($relop !~ m{\=}) {
                    $ninits ++;
                }
                # print "# ninits=$ninits, rest: $rest\n";
                $rest = ".";
            }
            my $ok = ($rest =~ m{\A\s*[\.\,\;]}) ? 1 : 0;
            if (0) {
            } elsif ($ok > 0 and ($expr =~ m{\^\(}             )) {
                $ok = 0;
            } elsif ($ok > 0 and ($expr =~ m{\^\(?n}           )) {
                $ok = 0;
            } elsif ($ok > 0 and ($expr =~ m{a\([n\+\-\d]+\)\^})) {
                $ok = 0;
            } elsif ($ok > 0) {
                my @indexes = $expr =~ m{a\(([^\)]+)\)}g;
                if ($ninits == 0) {
                	$ninits = scalar(@indexes);
                }
                my %shifts = ();
                foreach my $index (@indexes) {
                    my $orig_index = $index;
                    $orig_index =~ s{([\*\(\)\+\-])}{\\$1}g;
                    $index =~ s{\An\Z}{n+0};
                    my $shift = "+0";
                    if (0) {
                    } elsif ($index =~ m{\An([\+\-]\d+)?\Z}) {
                        $shift = $1;
                    } elsif ($index =~ m{\A([\+\-]?\d+)\+n\Z}) {
                        $shift = $1;
                        if ($shift !~ m{\A[\+\-]}) {
                            $shift = "+$shift";
                        }
                    } elsif ($index =~ m{\An\Z}) {
                        $shift = "+0";
                    } else {
                        $ok = 0;
                    }
                    $expr =~ s{a\($orig_index\)}{a\[n$shift\]};
                } # foreach
                if ($expr =~ m{\][\*\^]}) {
                    $ok = 0;
                } # a[...]* or a[...]^
                if ($ok > 0 and ($expr =~ m{\/(.*)})) {
                    my $divisor = $1;
                    if ($divisor =~ m{\A(\d+|\(\-\d+\))\Z}) {
                        $divisor =~ s{([\*\(\)\+\-])}{\\$1}g;
                        $expr =~ s{\/$divisor}{};
                        $expr = "$divisor*$expr";
                    } else {
                        $ok = 0;
                    }
                } # /
            }
            my $eqs = $expr =~ s{\=}{\=\=}g;
            if ($eqs <= 1 and $ok == 1 and length($expr) < 1024) {
                print join("\t", $aseqno, "Recurrence: $expr\.", $ninits, substr($rest, 0, 64)) . "\n"; 
            }
        } # contains a(n)
    } # %[NF]
} # while <>

sub norm_index {
} # norm_index
__DATA__
%F A000580 a(n) = (n^7 - 21*n^6 + 175*n^5 - 735*n^4 + 1624*n^3 - 1764*n^2 + 720*n)/5040.
%N A000588 a(n) = 7*binomial(2n,n-3)/(n+4).
%F A000588 (n+4)*a(n) +(-9*n-20)*a(n-1) +2*(13*n+5)*a(n-2) +(-25*n+38)*a(n-3) +2*(2*n-7)*a(n-4)=0. - _R. J. Mathar_, Jun 20 2013
%N A000589 a(n) = 11*binomial(2n,n-5)/(n+6).
%F A000589 -(n+6)*(n-5)*a(n) + 2*n*(2*n-1)*a(n-1) = 0. - _R. J. Mathar_, Jun 20 2013
%N A000590 a(n) = 13*binomial(2n,n-6)/(n+7).
%F A000590 -(n+7)*(n-6)*a(n) +2*n*(2*n-1)*a(n-1)=0. - _R. J. Mathar_, Jun 20 2013
%N A000643 a(n) = a(n-1) + 2^a(n-2).
%F A000657 a(n) = (-1)^(n)*Sum_{k=0..n} C(n,k)*Euler(n+k). - _Vladimir Kruchinin_, Apr 06 2015
%N A000659 a(n) = 2^a(n-1) + a(n-2).
%F A000660 a(n) = Sum_{k=0..n} A109449(n,k)*A028310(k). - _Reinhard Zumkeller_, Nov 04 2013
%N A000680 a(n) = (2n)!/2^n.

->

A030054 recform 4   (54+36*n)*a(n)+(-438-129*n)*a(n+1)+(714+138*n)*a(n+2)+(-432-63*n)*a(n+3)+(110+13*n)*a(n+4)+(-10-n)*a(n+5)=0 1,11,78,455,2380,11628,54264,245157,1081575,4686825,20030010,84672315,354817320,1476337800,6107086800,25140840660,103077446706,421171648758,1715884494940,6973199770790,28277527346376  21
A030056 recform 6   a(n+1)=a(n)*(2*n+2)*(2*n+3)/((n-5)*(n+8))   1,15,136,969,5985,33649,177100,888030,4292145,20160075,92561040,417225900,1852482996,8122425444,35240152720,151532656696,646626422970,2741188875414,11554258485616,48459472266975   20
A030180 recform 0   a(n)=(n^7-n)/42 0,0,3,52,390,1860,6665,19608,49932,113880,238095,463980,853138,1494012,2509845,4068080,6391320,9769968,14576667,21282660,30476190,42883060,59389473,81067272,109201700,145321800,191233575,249056028,321260202,410711340,520714285  31
A030297 recform 0   a(n)=n*(n+a(n-1))   0,1,6,27,124,645,3906,27391,219192,1972809,19728190,217010211,2604122676,33853594957,473950329594,7109254944135,113748079106416,1933717344809361,34806912206568822,661331331924807979   20
A032427 recform 0   a(n)=(3^(4*n+19)-(24*n+36)*7^(2*n+9)+(96*n^2+312*n+150)*5^(2*n+9)-(256*n^3+1344*n^2+1520*n+117)*3^(2*n+9)+512*n^4+3584*n^3+6208*n^2+1336*n-846)/196608  1,11069,4494351,834687179,109645021894,11966116940238,1171517154238290,107266611330420090,9412382749388124015,803475280086029066515,67362921649153881472361,5581153512072331417781229   12
A033182 recform 0   a(n)=[5*n/6]+1+[-4*n/5] 1,0,0,0,0,1,1,0,0,0,1,1,1,0,0,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,2,1,1,1,1,2,2,1,1,1,2,2,2,1,1,2,2,2,2,1,2,2,2,2,2,2,2,2,2,2,3,2,2,2,2,3,3,2,2,2,3,3,3,2,2,3,3,3,3,2,3,3,3,3,3,3,3   87
A033488 recform 0   a(n)=n*(n+1)*(n+2)*(n+3)/6  0,4,20,60,140,280,504,840,1320,1980,2860,4004,5460,7280,9520,12240,15504,19380,23940,29260,35420,42504,50600,59800,70200,81900,95004,109620,125860,143840,163680,185504,209440  33
A033504 recform 0   n*a(n)+6*(-2*n+1)*a(n-1)+48*(n-1)*a(n-2)+32*(-2*n+3)*a(n-3)=0   1,10,66,372,1930,9516,45332,210664,960858,4319100,19188796,84438360,368603716,1598231992,6889682280,29551095248,126193235194,536799072924,2275560109868,9616650989560,40527780684972,170368957887656    22
A033669 recform 0   a(n)=n^6*(n^6+1)*(n^2-1)    0,0,12480,4257360,251719680,5859750000,76189014720,664387432800,4329343549440,22594405433760,99000099000000,376611617793840,1275002791096320,3914079111480720,11055314381442240,29063182239000000,71776123339407360 17
A033815 recform 0   a(n)=2n*(2n-1)*a(n-1)+n*(n-1)*a(n-2)    1,1,14,426,24024,2170680,287250480,52370755920,12585067447680,3854801333416320,1465957162768492800,677696237345719468800,374281829360322587827200,243388909697235614324812800,184070135024053703140543027200,160192129141963141211280644352000  16
