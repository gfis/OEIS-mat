#!make

# OEIS-mat/data - extraction from repositories
# @(#) $Id$
# 2023-05-02: Georg Fischer
#
# from https://github.com/oeis/oeisdata        - sequence in internal format and b-files
#  and https://github.com/archmageirvine/joeis - Java programs
#---------------------------------
GITS=../..
COMMON=../common
DBAT=java -jar $(GITS)/dbat/dist/dbat-lite.jar -e UTF-8 -c worddb
HERE=../OEIS-mat/data
JOEIS=$(GITS)/joeis
OEISDATA=$(GITS)/oeisdata
REMOTE=set_environment_variable_REMOTE_to_g@a
REMDIR=$(REMOTE):~/work/gits/OEIS-mat/data
SLEEP=8
D=0
#-------------
all: 
help:
	grep -E "^[a-z]" makefile
#==============================
# the following are to be used on the remote server
#----
# Download stripped.gz, names.gz, bfilelist.gz
prep_down: prep1 prep2 prep3 prep_pack
prep1:
	rm -f stripped*
	wget https://oeis.org/stripped.gz
	gzip -df  stripped.gz
	cp -pv    stripped  $(COMMON)
	sleep $(SLEEP)
prep2:
	rm -f names*
	wget https://oeis.org/names.gz
	gzip -df  names.gz
	cp -pv    names     $(COMMON)
	sleep $(SLEEP)
prep3:
	rm -f bfilelist*
	wget https://oeis.org/bfilelist.gz
	gzip -df  bfilelist.gz
	cp -pv    bfilelist $(COMMON)
prep_pack:
	tar -czvf $@.tgz stripped names bfilelist
	ls -al
#----
catex_down: oeisdata_pull cat28 tinfo catex_pack
tinfo_down:                     tinfo catex_pack
#--
oeisdata_pull: # update the OEIS git repository
	cd $(OEISDATA) ; git pull
cat28: # reassemble the cat25.txt file
	cd $(OEISDATA) ; find seq -type f | sort > $(HERE)/$@.list.tmp
	rm -f    $@.txt
	cd $(OEISDATA) ; cat $(HERE)/$@.list.tmp | xargs -innn cat nnn >> $(HERE)/$@.txt
	head -n2 $@.txt
	wc -l    $@.txt
	ls -al   *$@.*
tinfo: # extract ASINFO, ASNAME, BFINFO database tables
	perl -w catex_info.pl -d $(D) cat28.txt
	ls -al ??????.txt
	wc -l  ??????.txt
catex_pack:
	tar -czvf $@.tgz asinfo.txt asname.txt bfinfo.txt
	ls -al *.tgz
#====
joeis_down: joeis_pull joeis_list1 joeis_list2 joeis_ofpre joeis_coral jcat28 joeis_pack
#--
joeis_pull:	# update Sean's jOEIS repository
	cd $(JOEIS) ; git pull | tee joeis_pull.`date +%Y-%m-%d.%H.%M`.txt
#--
# get the A-numbers and used superclasses of all implemented sequences
joeis_list1:
	find $(JOEIS)/src/irvine/oeis -iname "A??????.java" \
	| xargs -l grep -HP "( extends | implements |\@author|^\/\/ Generated by )" \
	>        $@.all.tmp || :
	head -n2 $@.all.tmp 
	wc -l    $@.all.tmp 
joeis_list2:
	grep -E  "public class *A" joeis_list1.all.tmp \
	| sed -e "s/[a-zA0-9\.\/]*://" \
	| sed -e "s/public class *A/A/" \
	      -e "s/ extends / /" \
	      -e "s/ implements / /" \
	      -e "s/ *[^A-Za-z0-9 ].*//" \
	      -e "s/ /\t/" \
	| sort \
	| grep -E "^A" \
	>        joeis_list.txt
	head -n2 joeis_list.txt
	wc -l    joeis_list.txt
#--
joeis_ofpre: # build a preliminary ofter file (with offset = terms = 0) for jcat25.pl
	grep -E "^A" joeis_list.txt | cut -b1-7 | sed -e "s/$$/\t0\t0,0,0,0,0,0,0,0$$/" \
	>        $@.txt
	head -n2 $@.txt
	wc -l    $@.txt
#--
joeis_coral: # get the A-numbers with "... implements Conjectural"
	grep -iE "Conjectural" joeis_list.txt \
	| cut -b1-7 \
	| sort > $@.txt
	head -n2 $@.txt
	wc -l    $@.txt
#--
joeis_ofter: # A-numbers implemented in jOEIS, offsets and a few terms, reduced by the A-numbers in joeis_coral
	perl delete_coral.pl -f joeis_coral.txt joeis_ofpre.txt \
	>        $@.txt
	head -n2 $@.txt
	wc -l    joeis*.txt
	cp -pv   $@.txt ../common
#--
jcat28: # qualify the cat28 lines with "#" = implemented in jOEIS, "%" = nyi, "?" = conjectured
	perl jcat28.pl -f joeis_ofpre.txt cat28.txt > $@.txt
	cut -b1 $@.txt | sort | uniq -c
	cp -pv    $@.txt ../common/jcat25.txt
#--
joeis_pack:
	tar -czvf $@.tgz jcat28.txt joeis_list1.all.tmp joeis_list.txt joeis_ofter.txt joeis_coral.txt
	ls -al   *.tgz
#========
# to be used locally:
#
remote: prep_remote jar_remote catex_remote joeis_remote
	cd ../common ; make asinfo_load asname_load bfinfo_load joeis_reload
#====
prep_remote: # download stripped, names, bfilelist
	ssh $(REMOTE)           "cd ~/work/gits/OEIS-mat/data/ ; make prep_pull"
	scp               $(REMOTE):~/work/gits/OEIS-mat/data/prep_pack.tgz .
	tar -xzvf prep_pack.tgz
	ls -al
	mv -v stripped names bfilelist ../common/
#====
catex_remote: # refresh oeisdata, generate cat28 and db table content and download
	ssh $(REMOTE)           "cd ~/work/gits/OEIS-mat/data ; git stash ; git pull"
	scp makefile *.pl $(REMOTE):~/work/gits/OEIS-mat/data/
	ssh $(REMOTE)           "cd ~/work/gits/OEIS-mat/data/ ; make catex_pull"
	scp               $(REMOTE):~/work/gits/OEIS-mat/data/catex.tgz .
	tar -xzvf catex.tgz
	ls -al
	mv -v asinfo.txt asname.txt bfinfo.txt ../common/
tinfo_remote: # refresh generate db table content and download
	ssh $(REMOTE)           "cd ~/work/gits/OEIS-mat/data ; git stash ; git pull"
	scp makefile *.pl $(REMOTE):~/work/gits/OEIS-mat/data/
	ssh $(REMOTE)           "cd ~/work/gits/OEIS-mat/data/ ; make tinfo_pull"
	scp               $(REMOTE):~/work/gits/OEIS-mat/data/catex.tgz .
	tar -xzvf catex.tgz
	ls -al
	mv -v asinfo.txt asname.txt bfinfo.txt ../common/
#====
joeis_remote: # update jOEIS repository, produce lists and jcat28, pack them and download
	ssh $(REMOTE)           "cd ~/work/gits/OEIS-mat/data ; git stash ; git pull"
	scp makefile *.pl $(REMOTE):~/work/gits/OEIS-mat/data/
	ssh $(REMOTE)           "cd ~/work/gits/OEIS-mat/data/ ; make joeis_pull"
	scp               $(REMOTE):~/work/gits/OEIS-mat/data/joeis_pack.tgz .
	tar -xzvf joeis_pack.tgz
	ls -al
	cp -pv jcat28.txt ../common/jcat25.txt
	cp -pv joeis_list1.all.tmp joeis_list.txt joeis_ofter.txt joeis_coral.txt ../common/
#====
jar_remote: # refresh jOEIS and rebuild the joeis.jar; needs > 8 GB RAM
	ssh $(REMOTE) "cd ~/work/gits/joeis ; git pull ; ant compile-internal jar"
	scp $(REMOTE):~/work/gits/joeis/build.tmp/joeis.jar $(JOEIS)/build.tmp/joeis.jar 
#========
jar_push:
	scp $(JOEIS)/build.tmp/joeis.jar $(REMOTE):work/gits/joeis/build.tmp/joeis.jar

xxx:
	ssh $(REMOTE) "cd ~/work/gits/joeis ; git pull ; cd ~/work/gits/OEIS-mat/data/