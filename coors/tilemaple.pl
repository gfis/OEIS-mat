#!perl

# Read coordination sequences and call Maple to derive a generating function
# @(#) $Id$
# 2020-05-13: $(GALID) passed through
# 2020-05-09, Georg Fischer: copied from holrec/holmaple.pl
# 
#:# Usage:
#:#   perl tilemaple.pl [-n num] [-t timeout] infile ... > outfile
#:#       -n    number of lines to be processed b one Maple activation (default 64)
#:#       -t    timeout for Maple in s, default 16
#---------------------------------
use strict;
use integer;
use warnings;
use POSIX;

my $version = "V1.1";
my ($sec, $min, $hour, $mday, $mon, $year, $wday, $yday, $isdst) = localtime(time);
my $timestamp = sprintf("%04d-%02d-%02d %02d:%02d:%02d"
        , $year + 1900, $mon + 1, $mday, $hour, $min, $sec);
my @parts = split(/\s+/, asctime(localtime(time)));  #  "Fri Jun  2 18:22:13 2000\n\0"
#                                             0   1    2 3        4
my $sigtime = sprintf("%s %02d %04d", $parts[1], $parts[2], $parts[4]);
#----
my $mapnum  = 64;
my $timeout = 16;
while (scalar(@ARGV) > 0 and ($ARGV[0] =~ m{\A[\-\+]})) {
    my $opt = shift(@ARGV);
    if (0) {
    } elsif ($opt  =~ m{n}) {
        $mapnum  = shift(@ARGV);
    } elsif ($opt  =~ m{t}) {
        $timeout = shift(@ARGV);
    } else {
        die "invalid option \"$opt\"\n";
    }
} # while $opt
#----
my $pattern = <<'Gfis';
read "C:\\Program Files\\Maple 2019\\FPS.mpl":
interface(prettyprint=0):
with(gfun):

printf("%s\t%s\t%a\n", "$(ASEQNO)", "$(GALID)", timelimit($(TIMEOUT), guessgf([$(SEQ)],x)));
Gfis
my ($pat1, $pat5) = split(/\n\n/, $pattern);
#----
my $buffer = ""; # for $mapnum input lines
my $count = 0;
while (<>) {
    next if $_ !~ m{\AA\d\d+\t};
    my $line = $_;
    $line =~ s{\s+\Z}{}; # chompr
    my ($aseqno, $callcode, $offset, $galid, $seq, @rest) = split(/\t/, $line);
    my $copy = $pat5;
    $copy =~ s{\$\(ASEQNO\)}  {$aseqno}g;
    $copy =~ s{\$\(GALID\)}   {$galid}g;
    $copy =~ s{\$\(SEQ\)}     {$seq}g;
    $copy =~ s{\$\(TIMEOUT\)} {$timeout}g;
    $buffer .= "$copy";
    $count ++;
    if ($count % $mapnum == 0) {
        &execute($aseqno);
    }
} # while <>
if (length($buffer) > 0) {
    &execute();
}

sub execute {
	my ($aseqno) = @_;
    my $filename = sprintf("tilemaple.tmp"); # $count
    open(MPL, ">", $filename) || die "cannot write to \"$filename\"";
    print MPL "$pat1\n";
    print MPL "$buffer\n";
    $buffer = "";
    close(MPL);
    my $maple = "\"C:/Program Files/Maple 2019/bin.X86_64_WINDOWS/cmaple.exe\"";
    my $cmd = "$maple -q $filename";
    # print STDERR "starting with $aseqno\n";
    my $result = `$cmd`;
    $result =~ s{\r}{}g; # remove Maple's carriage returns
    print        "$result";
    print STDERR substr($result, 0, 64) . " ...\n";
} # execute
__DATA__
A008486	tiler	0	Gal.1.1.1	1,3,6,9,12,15,18,21,24,27,30,33,36,39,42,45,48,51,54,57,60,63,66,69,72,75,78,81,84,87,90,93,96,99,102,105,108,111,114,117,120,123,126,129,132,135,138,141,144,147,150,153,156,159,162,165,168,171,174,177,180,183,186,189,192,195,198,201,204,207,210,213,216,219,222,225,228,231,234,237,240,243,246,249,252,255,258,261,264,267,270,273,276,279,282,285,288,291,294,297,300,303,306,309,312,315,318,321,324,327,330,333,336,339,342,345,348,351,354,357,360,363,366,369,372,375,378,381,384
A008576	tiler	0	Gal.1.2.1	1,3,5,8,11,13,16,19,21,24,27,29,32,35,37,40,43,45,48,51,53,56,59,61,64,67,69,72,75,77,80,83,85,88,91,93,96,99,101,104,107,109,112,115,117,120,123,125,128,131,133,136,139,141,144,147,149,152,155,157,160,163,165,168,171,173,176,179,181,184,187,189,192,195,197,200,203,205,208,211,213,216,219,221,224,227,229,232,235,237,240,243,245,248,251,253,256,259,261,264,267,269,272,275,277,280,283,285,288,291,293,296,299,301,304,307,309,312,315,317,320,323,325,328,331,333,336,339,341
A072154	tiler	0	Gal.1.3.1	1,3,5,7,9,12,15,17,19,21,24,27,29,31,33,36,39,41,43,45,48,51,53,55,57,60,63,65,67,69,72,75,77,79,81,84,87,89,91,93,96,99,101,103,105,108,111,113,115,117,120,123,125,127,129,132,135,137,139,141,144,147,149,151,153,156,159,161,163,165,168,171,173,175,177,180,183,185,187,189,192,195,197,199,201,204,207,209,211,213,216,219,221,223,225,228,231,233,235,237,240,243,245,247,249,252,255,257,259,261,264,267,269,271,273,276,279,281,283,285,288,291,293,295,297,300,303,305,307
A250122	tiler	0	Gal.1.4.1	1,3,4,6,8,12,14,15,18,21,22,24,28,30,30,33,38,39,38,42,48,48,46,51,58,57,54,60,68,66,62,69,78,75,70,78,88,84,78,87,98,93,86,96,108,102,94,105,118,111,102,114,128,120,110,123,138,129,118,132,148,138,126,141,158,147,134,150,168,156,142,159,178,165,150,168,188,174,158,177,198,183,166,186,208,192,174,195,218,201,182,204,228,210,190,213,238,219,198,222,248,228,206,231,258,237,214,240,268,246,222,249,278,255,230,258,288,264,238,267,298,273,246,276,308,282,254,285,318
A008574	tiler	0	Gal.1.5.1	1,4,8,12,16,20,24,28,32,36,40,44,48,52,56,60,64,68,72,76,80,84,88,92,96,100,104,108,112,116,120,124,128,132,136,140,144,148,152,156,160,164,168,172,176,180,184,188,192,196,200,204,208,212,216,220,224,228,232,236,240,244,248,252,256,260,264,268,272,276,280,284,288,292,296,300,304,308,312,316,320,324,328,332,336,340,344,348,352,356,360,364,368,372,376,380,384,388,392,396,400,404,408,412,416,420,424,428,432,436,440,444,448,452,456,460,464,468,472,476,480,484,488,492,496,500,504,508,512
A008574	tiler	0	Gal.1.6.1	1,4,8,12,16,20,24,28,32,36,40,44,48,52,56,60,64,68,72,76,80,84,88,92,96,100,104,108,112,116,120,124,128,132,136,140,144,148,152,156,160,164,168,172,176,180,184,188,192,196,200,204,208,212,216,220,224,228,232,236,240,244,248,252,256,260,264,268,272,276,280,284,288,292,296,300,304,308,312,316,320,324,328,332,336,340,344,348,352,356,360,364,368,372,376,380,384,388,392,396,400,404,408,412,416,420,424,428,432,436,440,444,448,452,456,460,464,468,472,476,480,484,488,492,496,500,504,508,512
A008579	tiler	0	Gal.1.7.1	1,4,8,14,18,22,28,30,38,38,48,46,58,54,68,62,78,70,88,78,98,86,108,94,118,102,128,110,138,118,148,126,158,134,168,142,178,150,188,158,198,166,208,174,218,182,228,190,238,198,248,206,258,214,268,222,278,230,288,238,298,246,308,254,318,262,328,270,338,278,348,286,358,294,368,302,378,310,388,318,398,326,408,334,418,342,428,350,438,358,448,366,458,374,468,382,478,390,488,398,498,406,508,414,518,422,528,430,538,438,548,446,558,454,568,462,578,470,588,478,598,486,608,494,618,502,628,510,638
A008706	tiler	0	Gal.1.8.1	1,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,95,100,105,110,115,120,125,130,135,140,145,150,155,160,165,170,175,180,185,190,195,200,205,210,215,220,225,230,235,240,245,250,255,260,265,270,275,280,285,290,295,300,305,310,315,320,325,330,335,340,345,350,355,360,365,370,375,380,385,390,395,400,405,410,415,420,425,430,435,440,445,450,455,460,465,470,475,480,485,490,495,500,505,510,515,520,525,530,535,540,545,550,555,560,565,570,575,580,585,590,595,600,605,610,615,620,625,630,635,640
A219529	tiler	0	Gal.1.9.1	1,5,11,16,21,27,32,37,43,48,53,59,64,69,75,80,85,91,96,101,107,112,117,123,128,133,139,144,149,155,160,165,171,176,181,187,192,197,203,208,213,219,224,229,235,240,245,251,256,261,267,272,277,283,288,293,299,304,309,315,320,325,331,336,341,347,352,357,363,368,373,379,384,389,395,400,405,411,416,421,427,432,437,443,448,453,459,464,469,475,480,485,491,496,501,507,512,517,523,528,533,539,544,549,555,560,565,571,576,581,587,592,597,603,608,613,619,624,629,635,640,645,651,656,661,667,672,677,683
A250120	tiler	0	Gal.1.10.1	1,5,9,15,19,24,29,33,39,43,48,53,57,63,67,72,77,81,87,91,96,101,105,111,115,120,125,129,135,139,144,149,153,159,163,168,173,177,183,187,192,197,201,207,211,216,221,225,231,235,240,245,249,255,259,264,269,273,279,283,288,293,297,303,307,312,317,321,327,331,336,341,345,351,355,360,365,369,375,379,384,389,393,399,403,408,413,417,423,427,432,437,441,447,451,456,461,465,471,475,480,485,489,495,499,504,509,513,519,523,528,533,537,543,547,552,557,561,567,571,576,581,585,591,595,600,605,609,615
A008458	tiler	0	Gal.1.11.1	1,6,12,18,24,30,36,42,48,54,60,66,72,78,84,90,96,102,108,114,120,126,132,138,144,150,156,162,168,174,180,186,192,198,204,210,216,222,228,234,240,246,252,258,264,270,276,282,288,294,300,306,312,318,324,330,336,342,348,354,360,366,372,378,384,390,396,402,408,414,420,426,432,438,444,450,456,462,468,474,480,486,492,498,504,510,516,522,528,534,540,546,552,558,564,570,576,582,588,594,600,606,612,618,624,630,636,642,648,654,660,666,672,678,684,690,696,702,708,714,720,726,732,738,744,750,756,762,768
A265035	tiler	0	Gal.2.1.1	1,3,6,9,11,14,17,21,25,28,30,32,35,39,43,46,48,50,53,57,61,64,66,68,71,75,79,82,84,86,89,93,97,100,102,104,107,111,115,118,120,122,125,129,133,136,138,140,143,147,151,154,156,158,161,165,169,172,174,176,179,183,187,190,192,194,197,201,205,208,210,212,215,219,223,226,228,230,233,237,241,244,246,248,251,255,259,262,264,266,269,273,277,280,282,284,287,291,295,298,300,302,305,309,313,316,318,320,323,327,331,334,336,338,341,345,349,352,354,356,359,363,367,370,372,374,377,381,385
A265036	tiler	0	Gal.2.1.2	1,4,6,7,10,14,20,24,24,23,26,34,42,44,40,37,42,54,64,64,56,51,58,74,86,84,72,65,74,94,108,104,88,79,90,114,130,124,104,93,106,134,152,144,120,107,122,154,174,164,136,121,138,174,196,184,152,135,154,194,218,204,168,149,170,214,240,224,184,163,186,234,262,244,200,177,202,254,284,264,216,191,218,274,306,284,232,205,234,294,328,304,248,219,250,314,350,324,264,233,266,334,372,344,280,247,282,354,394,364,296,261,298,374,416,384,312,275,314,394,438,404,328,289,330,414,460,424,344
A301287	tiler	0	Gal.2.2.1	1,3,6,7,8,15,18,17,20,25,28,29,30,35,40,39,40,47,50,49,52,57,60,61,62,67,72,71,72,79,82,81,84,89,92,93,94,99,104,103,104,111,114,113,116,121,124,125,126,131,136,135,136,143,146,145,148,153,156,157,158,163,168,167,168,175,178,177,180,185,188,189,190,195,200,199,200,207,210,209,212,217,220,221,222,227,232,231,232,239,242,241,244,249,252,253,254,259,264,263,264,271,274,273,276,281,284,285,286,291,296,295,296,303,306,305,308,313,316,317,318,323,328,327,328,335,338,337,340
A301289	tiler	0	Gal.2.2.2	1,4,5,6,12,14,15,18,21,26,28,26,31,38,37,38,44,46,47,50,53,58,60,58,63,70,69,70,76,78,79,82,85,90,92,90,95,102,101,102,108,110,111,114,117,122,124,122,127,134,133,134,140,142,143,146,149,154,156,154,159,166,165,166,172,174,175,178,181,186,188,186,191,198,197,198,204,206,207,210,213,218,220,218,223,230,229,230,236,238,239,242,245,250,252,250,255,262,261,262,268,270,271,274,277,282,284,282,287,294,293,294,300,302,303,306,309,314,316,314,319,326,325,326,332,334,335,338,341
